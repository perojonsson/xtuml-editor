package com.mentor.nucleus.bp.core.ui.actions;
//======================================================================
//
// File: com/mentor/nucleus/bp/core/ui/GenericPackageAssignClassOnO_IOBJAction.java
//
// WARNING:      Do not edit this generated file
// Generated by: arc/create_selection_dialog_action.inc
// Version:      $Revision: 1.10 $
//
// (c) Copyright 2005-2014 by Mentor Graphics Corp.  All rights reserved.
//
//======================================================================
//
// This class is the main BridgePoint entry point for the action that
// opens a selection dialog for Assign Classs.
//

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

import org.eclipse.jface.action.IAction;
import org.eclipse.jface.viewers.ISelection;
import org.eclipse.jface.viewers.IStructuredSelection;
import org.eclipse.jface.window.Window;
import org.eclipse.ui.IActionDelegate;
import org.eclipse.ui.IObjectActionDelegate;
import org.eclipse.ui.IWorkbenchPart;
import org.eclipse.ui.PlatformUI;

import com.mentor.nucleus.bp.core.*;
import com.mentor.nucleus.bp.core.common.*;
import com.mentor.nucleus.bp.core.ui.*;
import com.mentor.nucleus.bp.core.util.*;
import com.mentor.nucleus.bp.core.ui.dialogs.*;
import org.osgi.service.prefs.*;
import com.mentor.nucleus.bp.core.ui.preferences.*;

public class GenericPackageAssignClassOnO_IOBJAction
		implements
			IObjectActionDelegate {

	/**
	 * Constructor for GenericPackageAssignClassOnO_IOBJAction.
	 */
	public GenericPackageAssignClassOnO_IOBJAction() {
		super();
	}
	/**
	 * @see IObjectActionDelegate#setActivePart(IAction, IWorkbenchPart)
	 */
	public void setActivePart(IAction action, IWorkbenchPart targetPart) {
		// The part is mainly needed to locate the selection provider, and
		// we cache our selection in core so no action is needed here.
	}
	/**
	 * @see IActionDelegate#run(IAction)
	 */
	public void run(IAction action) {
		IStructuredSelection structuredSelection = Selection.getInstance()
				.getStructuredSelection();
		O_IOBJ_GenericPackageAssignClass(structuredSelection);
	}
	/**
	 * @see IActionDelegate#selectionChanged(IAction, ISelection)
	 */
	public void selectionChanged(IAction action, ISelection selection) {
		// do nothing
	}
	public static void O_IOBJ_GenericPackageAssignClass(
			IStructuredSelection selection) {
		// Assign the context selection variables with the action context 
		// Assign the context selection variable with the action context 
		Object context = selection.iterator().next();
		ImportedClass_c v_element = (ImportedClass_c) context;
		// select related by where USER::selectExisting
		ModelClass_c v_existingElement = ModelClass_c
				.getOneO_OBJOnR101(v_element);

		// ensure that all Model Classs are loaded
		PersistenceManager.ensureAllInstancesLoaded(v_element.getModelRoot(),
				ModelClass_c.class);
		// now find all the elements that should be shown 
		ModelClass_c[] elements = getElements(v_element);
		PackageableElement_c pe = PackageableElement_c
				.getOnePE_PEOnR8001(v_element);
		Package_c pkg = Package_c.getOneEP_PKGOnR8000(pe);
		Component_c comp = Component_c.getOneC_COnR8003(pe);
		ElementSelectionDialog dialog = new ElementSelectionDialog(PlatformUI
				.getWorkbench().getActiveWorkbenchWindow().getShell(),
				elements, "class", true, v_existingElement, false, null);
		dialog.setBlockOnOpen(true);
		dialog.setTitle("Assign Class Selection");
		int result = dialog.open();
		if (result == Window.OK) {
			ModelClass_c v_selectedObj = (ModelClass_c) dialog.getResult()[0];
			if (v_selectedObj != null) {

				TransactionUtil.TransactionGroup transactionGroup = TransactionUtil
						.startTransactionsOnSelectedModelRoots("Generic Package Assign Class");
				try {
					// Ensure that actions take place between Verifier Activity executions
					Ooaofooa.beginSaveOperation();
					if ((v_element != null)) {

						if ((v_selectedObj != null)) {

							if (v_element != null) {
								v_element
										.unrelateAcrossR101From(v_existingElement);
							} else {
								Throwable t = new Throwable();
								t.fillInStackTrace();
								CorePlugin
										.logError(
												"Unrelate attempted on null left hand instance.",
												t);
							}

							if (v_element != null) {
								v_element.relateAcrossR101To(v_selectedObj);
							} else {
								Throwable t = new Throwable();
								t.fillInStackTrace();
								CorePlugin
										.logError(
												"Relate attempted on null left hand instance.",
												t);
							}

						}

					}

					// end critical section
					Ooaofooa.endSaveOperation();
					// catch all exceptions and cancel the transactions
				} catch (Exception e) {
					Ooaofooa.endSaveOperation();
					TransactionUtil.cancelTransactions(transactionGroup, e);
					CorePlugin
							.logError(
									"Transaction: Generic Package Assign Class failed", e);//$NON-NLS-1$
				}
				TransactionUtil.endTransactions(transactionGroup);
			}
		}

	}
	public static ModelClass_c[] getElements(ImportedClass_c v_element) {
      List<ModelClass_c> elementList = new ArrayList<ModelClass_c>();
      PackageableElement_c pe = PackageableElement_c.getOnePE_PEOnR8001(v_element);
      Package_c pkg = Package_c.getOneEP_PKGOnR8000(pe);
      Component_c comp = Component_c.getOneC_COnR8003(pe);
	  boolean isInGenericPackage = ((pkg !=null) || (comp !=null));
      if (!isInGenericPackage) {
        Ooaofooa[] instancesUnderSystem = Ooaofooa.getInstancesUnderSystem(v_element.getModelRoot());
        for(int i = 0; i < instancesUnderSystem.length; i++) {
    	  ModelClass_c[] elementInstances = ModelClass_c.ModelClassInstances(instancesUnderSystem[i]);
    	  for(int j = 0; j < elementInstances.length; j++) {
		  	ModelClass_c elem = elementInstances[j];
			          if (v_element.Canassigntoclass(elem.getObj_id())) {
    			  elementList.add(elem);
			         }
    	  }
        }
		SystemModel_c sys = ((Ooaofooa)v_element.getModelRoot()).getRoot();
		if (sys.getUseglobals()) {
		  PackageableElement_c[] pes = PackageableElement_c.
		             getManyPE_PEsOnR9100(GlobalElementInSystem_c.
				                                     getManyG_EISsOnR9100(sys));
          ModelClass_c[] elementInstances = ModelClass_c.getManyO_OBJsOnR8001(pes);
  	      for(int j = 0; j < elementInstances.length; j++) {
		  	ModelClass_c elem = elementInstances[j];
			if (!elementList.contains(elem)) {
			  // add elements once only
    		  elementList.add(elem);
		    }
  	      }
		}
	  }
      else {
	  	PackageableElement_c[] pes = null;
        if (pkg != null) {
          pkg.Clearscope();
          pkg.Collectvisibleelementsforname(false, Gd_c.Null_unique_id(), false,
                      "", pkg.getPackage_id(), Elementtypeconstants_c.CLASS);
		  class PETest implements ClassQueryInterface_c {
				public boolean evaluate(Object candidate) {
					SearchResultSet_c selected = (SearchResultSet_c) candidate;
					return (selected.getName().equals("") &&
                         selected.getType() == Elementtypeconstants_c.CLASS);
				}
		  }
		  SearchResultSet_c results =
			           SearchResultSet_c.getOnePE_SRSOnR8005(pkg, new PETest());
          pes = PackageableElement_c.getManyPE_PEsOnR8002(
		                    ElementVisibility_c.getManyPE_VISsOnR8006(results));
        }
        else {
          if (comp != null) {
            comp.Clearscope();
            comp.Collectvisibleelementsforname(false, Gd_c.Null_unique_id(), "",
            		             comp.getId(), Elementtypeconstants_c.CLASS);
  		    class PETest implements ClassQueryInterface_c {
				public boolean evaluate(Object candidate) {
					ComponentResultSet_c selected = (ComponentResultSet_c) candidate;
					return (selected.getName().equals("") &&
                       selected.getType() == Elementtypeconstants_c.CLASS);
				}
		    }
		    ComponentResultSet_c results =
			       ComponentResultSet_c.getOnePE_CRSOnR8007(comp, new PETest());
            pes = PackageableElement_c.getManyPE_PEsOnR8004(
                          ComponentVisibility_c.getManyPE_CVSsOnR8008(results));
          }
        }
        for (int i = 0; pes != null && i < pes.length; i++) {
                    ModelClass_c elem = ModelClass_c.getOneO_OBJOnR8001(pes[i]);
			          if (v_element.Canassigntoclass(elem.getObj_id())) {
            elementList.add(elem);
			         }
        }
      }
	return elementList.toArray(new ModelClass_c[elementList.size()]);
  } // end getElements(ImportedClass_c) 
} // end GenericPackageAssignClassOnO_IOBJAction

